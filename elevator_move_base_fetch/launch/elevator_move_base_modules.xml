<launch>
  <arg name="scene" default="eng2"/>
  <arg name="MANAGER" default="elevator_move_base_manager"/>

  <node name="$(arg MANAGER)"
        pkg="nodelet" type="nodelet"
        args="manager"
        respawn="true" output="screen"/>

  <!-- Detect elevator_call_panel / elevator_inside_panel and broadcast TF. -->
  <group ns="/head_camera/mono">
    <node name="lightweight_throttle"
          pkg="nodelet" type="nodelet"
          args="load jsk_topic_tools/LightweightThrottle /$(arg MANAGER)">
      <remap from="~input" to="image_rect"/>
      <remap from="~output" to="image_rect_throttle"/>
      <rosparam>
        update_rate: 2.0
      </rosparam>
    </node>
    <node name="imagesift"
          pkg="nodelet" type="nodelet"
          args="load imagesift/ImageSift /$(arg MANAGER)"
          launch-prefix="nice -n +10">
      <remap from="image" to="image_rect_throttle"/>
    </node>
    <include file="$(find elevator_move_base_fetch)/launch/elevator_panels_detection_$(arg scene).launch">
      <arg name="INPUT_FEATURE" value="ImageFeature0D"/>
      <arg name="MANAGER" value="/$(arg MANAGER)"/>
    </include>
    <node name="find_elevator_button"
          pkg="elevator_move_base_fetch" type="find-elevator-button.l"
          respawn="true" output="screen"/>
  </group>

  <!-- Read current elevator floor. -->
  <group ns="/head_camera/mono">
    <node name="pass_through_image_rect"
          pkg="nodelet" type="nodelet"
          args="load jsk_topic_tools/Passthrough /$(arg MANAGER)">
      <remap from="~input" to="image_rect"/>
      <remap from="~output" to="pass_through_image_rect_output"/>
      <rosparam>
        default_duration: 0.0  # infinite
      </rosparam>
    </node>
  </group>
  <node name="panel_camera"
        pkg="jsk_perception" type="virtual_camera_mono">
    <remap from="image" to="/head_camera/mono/pass_through_image_rect_output"/>
    <rosparam>
      initial_pos: [0.42, 0.0, 0.0]
    </rosparam>
  </node>
  <node name="elevator_number"
        pkg="elevator_move_base_pr2" type="match_template.py"
        output="screen">
    <remap from="~image" to="/panel_camera/image"/>
    <rosparam command="load"
              file="$(find elevator_move_base_pr2)/launch/template-$(arg scene).yaml"/>
    <rosparam>
      show_probability: false
      show_image: false
    </rosparam>
  </node>

  <!-- Check if elevator door is open. -->
  <include file="$(find elevator_move_base_fetch)/launch/check_elevator_open.xml">
    <arg name="INPUT_CLOUD" value="/head_camera/mono/depth_registered/quater/throttled/points"/>
  </include>

</launch>
